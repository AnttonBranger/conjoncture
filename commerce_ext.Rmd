---
title: "Commerce extérieur"
output: html_document
date: "2025-11-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Chargement des packages
```{r}
library(eurostat)
library(tidyverse)
library(lubridate)
library(janitor)
library(ggthemes)
library(mFilter)
library(zoo)
library(seasonal)
```

# Import/export de biens

Importation des données 
```{r}
biens <- get_eurostat("ext_st_27_2020msbec", time_format = "date")
biens_pt <- biens %>%
  filter(
    geo == "PT",
    stk_flow %in% c("EXP", "IMP"),
    partner == "WORLD",
    bclas_bec == "TOTAL",
    indic_et == "TRD_VAL_SCA"
  ) %>%
  select(TIME_PERIOD, stk_flow, values)
```

```{r}
biens_pt_q <- biens_pt %>%
  mutate(quarter = floor_date(TIME_PERIOD, "quarter")) %>%
  group_by(quarter, stk_flow) %>%
  summarise(values = sum(values), .groups = "drop")
```

# Import/export de services

```{r}
services <- get_eurostat("bop_c6_q", time_format = "date")

services_pt <- services %>%
  filter(
    geo == "PT",
    bop_item == "S",       # Services totaux
    stk_flow %in% c("CRE", "DEB"),
    currency == "MIO_EUR", 
    sector10 == "S1",
    sectpart == "S1",
    partner == "WRL_REST"
  ) %>%
  select(TIME_PERIOD, stk_flow, values) %>% 
  rename(quarter = TIME_PERIOD)
```

On retire la saisonnalité 
```{r}
services_pt2 <- services_pt %>%
  arrange(stk_flow, quarter) %>%
  mutate(series_id = stk_flow)

x13_apply <- function(df) {
  ts_data <- ts(
    df$values,
    start = c(year(min(df$quarter)), quarter(min(df$quarter))),
    frequency = 4
  )
  
  sa <- seas(ts_data)
  
  tibble(
    quarter = df$quarter,
    sa_values = as.numeric(final(sa))
  )
}

services_sa <- services_pt2 %>%
  group_by(series_id) %>%
  group_modify(~ x13_apply(.x)) %>%
  ungroup()

services_pt_sa <- services_pt2 %>%
  left_join(services_sa, by = c("series_id", "quarter")) %>% 
  select(-series_id) %>% 
  select(-values) %>% 
  rename(values = sa_values)
```


# Import/export de biens et services

```{r}
export_import_q <- biens_pt_q %>%
  rename(item = stk_flow) %>%
  mutate(type = "Biens") %>%
  bind_rows(
    services_pt_sa %>%
      rename(item = stk_flow) %>%
      mutate(type = "Services")
  )
```

Graphique
```{r}
ggplot(export_import_q, aes(x = quarter, y = values, color = item)) +
  geom_line(linewidth = 1.2) +
  facet_wrap(~ type, scales = "free_y") +
  labs(
    title = "Portugal — Exportations et importations de biens & services",
    x = "Trimestre",
    y = "Millions d'euros",
    color = ""
  ) +
  theme_minimal()
```

# Solde commerciale

```{r}
solde_biens <- biens_pt_q %>%
  pivot_wider(names_from = stk_flow, values_from = values) %>%
  mutate(solde = EXP - IMP)

solde_services <- services_pt_sa %>%
  pivot_wider(names_from = stk_flow, values_from = values) %>%
  mutate(solde = DEB - CRE)
```

```{r}
solde_total <- solde_biens %>%
  select(quarter, solde) %>%
  rename(solde_biens = solde) %>%
  left_join(
    solde_services %>% select(quarter, solde) %>% rename(solde_services = solde),
    by = "quarter"
  ) %>%
  mutate(solde_total = solde_biens + solde_services)

ggplot(solde_total, aes(x = quarter)) +
  geom_line(aes(y = solde_total), linewidth = 1.3, color = "darkred") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Portugal — Solde commercial (biens + services)",
    y = "Millions d'euros",
    x = ""
  ) +
  theme_minimal()
```


# Taux de change effectif

```{r}
tce <- get_eurostat("ert_eff_ic_q", time_format = "date")

tce_pt <- tce %>%
  filter(
    geo == "PT",
    unit == "I15",        
    exch_rt == "REER_EA20_ULCT"
  ) %>%
  select(TIME_PERIOD, values) %>%
  rename(quarter = TIME_PERIOD)
```

Graphique 
```{r}
ggplot(tce_pt, aes(x = quarter, y = values)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  labs(
    title = "Portugal — Taux de change effectif nominal (NEER)",
    x = "Trimestre",
    y = "Index (2015 = 100)"
  ) +
  theme_minimal()
```
